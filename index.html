<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- ENHANCED SECURITY HEADERS -->
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="no-referrer">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), camera=(), payment=(), usb=(), microphone=()">
    <meta name="robots" content="noindex, nofollow">
    
    <title>HR Admin Dashboard - Secured</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23dc3545'/%3E%3Ctext x='50' y='50' font-family='Arial, sans-serif' font-size='45' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='central'%3EHR%3C/text%3E%3C/svg%3E">
    <meta name="theme-color" content="#dc3545">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e3c72;
            --primary-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #212529;
            --border: #dee2e6;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--primary-gradient);
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 450px;
            text-align: center;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-box h1 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 32px;
            font-weight: 700;
        }

        .login-box p {
            color: #666;
            margin-bottom: 35px;
            font-size: 16px;
        }

        .security-badge {
            background: var(--danger);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            margin-bottom: 25px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.25);
        }

        .login-box input {
            width: 100%;
            padding: 16px 20px;
            margin-bottom: 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            transition: var(--transition);
            font-family: inherit;
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(30, 60, 114, 0.1);
        }

        .login-box button {
            width: 100%;
            padding: 16px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .login-box button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 60, 114, 0.3);
        }

        .login-box button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-message {
            color: var(--danger);
            margin-top: 15px;
            display: none;
            font-weight: 500;
            background: #fff5f5;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--danger);
        }

        .error-message.show {
            display: block;
        }

        .dashboard-header {
            background: var(--primary-gradient);
            color: white;
            padding: 30px 40px;
            box-shadow: var(--shadow-md);
        }

        .dashboard-header h1 {
            font-size: 32px;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .dashboard-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: white;
            color: var(--primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-warning {
            background: var(--warning);
            color: #856404;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .dashboard-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            border-left: 5px solid var(--primary);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .stat-card h3 {
            color: #6c757d;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .stat-card .stat-value {
            color: var(--primary);
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
        }

        .stat-card .stat-change {
            font-size: 13px;
            color: #6c757d;
        }

        .table-container {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .table-header {
            padding: 25px 30px;
            background: var(--light);
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h2 {
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .submissions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .submissions-table thead {
            background: var(--primary);
            color: white;
        }

        .submissions-table th {
            padding: 18px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }

        .submissions-table td {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .submissions-table tbody tr {
            transition: var(--transition);
        }

        .submissions-table tbody tr:hover {
            background: #f8f9ff;
        }

        .submissions-table tbody tr.unscored {
            background: #fffbf0;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge.pass {
            background: #d4edda;
            color: #155724;
        }

        .badge.fail {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.unscored {
            background: #fff3cd;
            color: #856404;
        }

        .badge.audio-yes {
            background: #d4edda;
            color: #155724;
        }

        .badge.audio-no {
            background: #f8d7da;
            color: #721c24;
        }

        .btn-view {
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn-view:hover {
            background: #1a3461;
            transform: scale(1.05);
        }

        .modal {
            display: none !important;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 99999;
            overflow-y: auto;
            padding: 40px 20px;
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex !important;
            align-items: flex-start;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 1100px;
            width: 100%;
            margin: auto;
            animation: slideUp 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--light);
            align-items: center;
        }

        .modal-header h2 {
            color: var(--primary);
            font-size: 28px;
            font-weight: 700;
        }

        .close-modal {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .close-modal:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .info-section {
            background: var(--light);
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid var(--primary);
        }

        .info-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: 600;
        }

        .info-section p {
            margin: 10px 0;
            color: #333;
            font-size: 15px;
        }

        .info-section strong {
            color: var(--primary);
        }

        .audio-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 30px;
            border-radius: 12px;
            margin: 30px 0;
        }

        .audio-section h3 {
            color: #0d47a1;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
        }

        .audio-player {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
        }

        .audio-player audio {
            width: 100%;
            margin-bottom: 15px;
        }

        .audio-info {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
        }

        .violation-breakdown {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .violation-breakdown h4 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .violation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .violation-item {
            background: var(--light);
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--warning);
            transition: var(--transition);
        }

        .violation-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-sm);
        }

        .violation-item.high {
            border-left-color: var(--danger);
            background: #fff5f5;
        }

        .violation-item.zero {
            border-left-color: var(--success);
            background: #f0fff4;
        }

        .violation-label {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .violation-label small {
            display: block;
            color: #666;
            font-size: 12px;
            margin-top: 4px;
            font-weight: 400;
        }

        .violation-count {
            background: var(--warning);
            color: #856404;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 16px;
        }

        .violation-count.high {
            background: var(--danger);
            color: white;
        }

        .violation-count.zero {
            background: var(--success);
            color: white;
        }

        .violation-alert {
            padding: 20px;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
            margin-top: 20px;
        }

        .violation-alert.high {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid var(--danger);
        }

        .violation-alert.moderate {
            background: #fff3cd;
            color: #856404;
            border: 2px solid var(--warning);
        }

        .violation-alert.low {
            background: #d4edda;
            color: #155724;
            border: 2px solid var(--success);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 4px solid var(--light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .dashboard-header {
                padding: 20px;
            }

            .dashboard-header h1 {
                font-size: 24px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
            }

            .header-actions .btn {
                flex: 1;
            }

            .modal-content {
                padding: 25px 20px;
            }

            .modal-header {
                flex-direction: column;
                gap: 15px;
            }

            .modal-header h2 {
                font-size: 22px;
            }

            .violation-grid {
                grid-template-columns: 1fr;
            }

            .submissions-table {
                font-size: 13px;
            }

            .submissions-table th,
            .submissions-table td {
                padding: 12px 10px;
            }
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #1a3461;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #495057;
        }

        .empty-state p {
            font-size: 16px;
        }

        .user-email {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 13px;
            margin-left: 10px;
        }

        .answers-section {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .answers-section h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
        }

        .answer-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }

        .answer-item.correct {
            border-left-color: var(--success);
            background: #f0fff4;
        }

        .answer-item.incorrect {
            border-left-color: var(--danger);
            background: #fff5f5;
        }

        .answer-question {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 15px;
        }

        .answer-response {
            color: #333;
            margin: 8px 0;
            padding-left: 15px;
        }

        .answer-correct-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .answer-correct-indicator.correct {
            background: #d4edda;
            color: #155724;
        }

        .answer-correct-indicator.incorrect {
            background: #f8d7da;
            color: #721c24;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyCwulSy8UIY_DDF4A3fhiPNm4gJmbfg8Iw",
          authDomain: "customer-service-assessm-1c9e5.firebaseapp.com",
          databaseURL: "https://customer-service-assessm-1c9e5-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "customer-service-assessm-1c9e5",
          storageBucket: "customer-service-assessm-1c9e5.firebasestorage.app",
          messagingSenderId: "187392191155",
          appId: "1:187392191155:web:4f88f966057e1b7815dec6"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
    </script>
</head>
<body>
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="login-box">
                <div class="security-badge">
                    <span>🔐</span>
                    <span>SECURED ADMIN ACCESS</span>
                </div>
                <h1>HR Admin Panel</h1>
                <p>Firebase Authentication Required</p>
                <form id="loginForm">
                    <input type="email" id="adminEmail" placeholder="Admin Email" required autocomplete="username">
                    <input type="password" id="adminPassword" placeholder="Password" required autocomplete="current-password">
                    <button type="submit" id="loginBtn">Access Dashboard</button>
                </form>
                <div class="error-message" id="loginError">❌ Authentication failed.</div>
            </div>
        </div>
    </div>

    <div id="dashboardPage" class="page">
        <div class="dashboard-header">
            <h1>📊 HR Assessment Dashboard</h1>
            <p>Secured with Firebase Auth <span class="user-email" id="userEmail"></span></p>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="loadData()">
                    <span>🔄</span>
                    <span>Refresh Data</span>
                </button>
                <button class="btn btn-warning" onclick="scoreAllUnscored()" id="scoreBtn">
                    <span>🎯</span>
                    <span>Calculate Scores</span>
                </button>
                <button class="btn btn-success" onclick="downloadAll()">
                    <span>📥</span>
                    <span>Download All</span>
                </button>
                <button class="btn btn-danger" onclick="logout()">
                    <span>🚪</span>
                    <span>Logout</span>
                </button>
            </div>
        </div>

        <div class="dashboard-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Submissions</h3>
                    <div class="stat-value" id="totalSubs">0</div>
                    <div class="stat-change">All time</div>
                </div>
                <div class="stat-card" style="border-left-color: var(--success);">
                    <h3>Passed</h3>
                    <div class="stat-value" id="totalPassed" style="color: var(--success);">0</div>
                    <div class="stat-change">70% or higher</div>
                </div>
                <div class="stat-card" style="border-left-color: var(--danger);">
                    <h3>Failed</h3>
                    <div class="stat-value" id="totalFailed" style="color: var(--danger);">0</div>
                    <div class="stat-change">Below 70%</div>
                </div>
                <div class="stat-card" style="border-left-color: var(--warning);">
                    <h3>Average Score</h3>
                    <div class="stat-value" id="avgScore" style="color: var(--warning);">0%</div>
                    <div class="stat-change">Mean percentage</div>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h2>All Submissions</h2>
                </div>
                <div class="table-wrapper">
                    <div id="tableContent">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading submissions...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📋 Submission Details</h2>
                <button class="close-modal" onclick="closeModal()">✕ Close</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // ============ XSS PROTECTION ============
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function safeNumber(num) {
            const parsed = parseInt(num);
            return (isNaN(parsed) || parsed < 0 || parsed > 100) ? 0 : parsed;
        }

        function safeDate(dateString) {
            try {
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? 'Invalid Date' : date.toLocaleString();
            } catch {
                return 'Invalid Date';
            }
        }

        // ============ GLOBAL VARIABLES ============
        let allSubs = [];
        let currentSub = null;
        let currentUser = null;
        let correctAnswers = [];
        const questions = [
            "What is the most important skill in customer service?",
            "A customer is angry about a delayed delivery. What should you do FIRST?",
            "What does 'active listening' mean in customer service?",
            "How should you handle a customer request you cannot immediately fulfill?",
            "What is the best way to end a customer service interaction?",
            "A customer is using inappropriate language. What should you do?",
            "What is the purpose of asking clarifying questions?",
            "How should you prioritize multiple customer requests?",
            "What should you do if you don't know the answer to a customer's question?",
            "What is the key to building customer loyalty?",
            "When should you escalate a customer issue to a supervisor?",
            "What is the best approach to handling customer complaints?",
            "How should you communicate with a customer who is hard to understand?",
            "What does 'going the extra mile' mean in customer service?",
            "How should you handle multiple tasks while assisting a customer?",
            "What is the importance of product knowledge in customer service?",
            "How should you respond to positive customer feedback?",
            "What is the best way to handle an upset customer who wants a refund outside of policy?",
            "Describe a time when you successfully handled a difficult customer situation...",
            "Imagine a customer contacts you saying they received the wrong product..."
        ];

        const questionOptions = [
            ["Speed of response", "Active listening and empathy", "Technical knowledge only", "Following scripts exactly"],
            ["Explain company policies", "Acknowledge their frustration and apologize", "Transfer them to a manager", "Offer a discount immediately"],
            ["Listening while doing other tasks", "Fully concentrating, understanding, and responding appropriately", "Waiting for your turn to speak", "Taking notes only"],
            ["Say 'I don't know' and end the call", "Set clear expectations and follow up", "Make promises you might not keep", "Ignore the request"],
            ["Hang up quickly", "Ask if there's anything else you can help with and thank them", "Just say goodbye", "Transfer to another department"],
            ["Use inappropriate language back", "Remain professional and politely request respectful communication", "Hang up immediately", "Laugh it off"],
            ["To confuse the customer", "To fully understand the customer's issue and provide accurate solutions", "To extend call time", "To show off knowledge"],
            ["Random order", "By urgency and impact", "Ignore less important ones", "Only help familiar customers"],
            ["Make up an answer", "Admit you don't know and find someone who does or research it", "Change the subject", "Blame the customer"],
            ["Low prices only", "Consistent, reliable, and personalized service", "Fancy marketing", "Long phone calls"],
            ["For every single request", "When you've exhausted your authority and resources", "Never escalate", "Only on Fridays"],
            ["Defend the company immediately", "Listen, empathize, apologize, and offer solutions", "Blame other departments", "Minimize the issue"],
            ["Pretend you understand", "Ask politely for clarification and confirm understanding", "Get frustrated and transfer", "Speak louder"],
            ["Working overtime", "Exceeding expectations and providing exceptional service", "Doing the bare minimum", "Selling more products"],
            ["Multitask constantly", "Focus fully on the customer, then handle other tasks", "Ask the customer to wait indefinitely", "Rush through everything"],
            ["Not important at all", "Helps provide accurate information and build trust", "Only for sales people", "Can be ignored"],
            ["Ignore it", "Thank them and share it with your team", "Ask for money", "Take all credit yourself"],
            ["Immediately say no", "Explain the policy empathetically and explore alternative solutions", "Give refund without checking", "Argue about the policy"],
            null,
            null
        ];

        // ============ AUTHENTICATION ============
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                const safeEmail = escapeHtml(user.email);
                document.getElementById('userEmail').textContent = safeEmail;
                document.getElementById('loginPage').classList.remove('active');
                document.getElementById('dashboardPage').classList.add('active');
                loadData();
            } else {
                currentUser = null;
                document.getElementById('loginPage').classList.add('active');
                document.getElementById('dashboardPage').classList.remove('active');
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorMsg = document.getElementById('loginError');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Authenticating...';
            errorMsg.classList.remove('show');
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error('Login error:', error);
                errorMsg.textContent = `❌ ${escapeHtml(error.message)}`;
                errorMsg.classList.add('show');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Access Dashboard';
            }
        });

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut().then(() => {
                    document.getElementById('adminEmail').value = '';
                    document.getElementById('adminPassword').value = '';
                });
            }
        }

        // ============ LOAD CORRECT ANSWERS FROM FIREBASE ============
        async function loadCorrectAnswers() {
            try {
                const snapshot = await database.ref('correctAnswers').once('value');
                if (snapshot.exists()) {
                    const answersObj = snapshot.val();
                    correctAnswers = Object.keys(answersObj)
                        .sort((a, b) => parseInt(a) - parseInt(b))
                        .map(key => answersObj[key]);
                    console.log('✅ Loaded correct answers:', correctAnswers.length);
                    return true;
                } else {
                    console.error('❌ No correct answers found in Firebase');
                    alert('ERROR: Correct answers not found in database.\n\nPlease add them to Firebase:\n1. Go to Firebase Console\n2. Database → Add "correctAnswers" node\n3. Import the correct answers JSON');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error loading answers:', error);
                alert('Error loading correct answers: ' + error.message);
                return false;
            }
        }

        // ============ CALCULATE SCORE FOR SUBMISSION ============
        async function calculateScore(submissionKey, submission) {
            if (!correctAnswers || correctAnswers.length === 0) {
                console.log('Loading correct answers first...');
                const loaded = await loadCorrectAnswers();
                if (!loaded) return false;
            }

            let correctCount = 0;
            let totalMCQ = 0;

            submission.answers.forEach((answer, index) => {
                if (index < 18) { // First 18 are MCQ
                    totalMCQ++;
                    if (answer === correctAnswers[index]) {
                        correctCount++;
                    }
                }
            });

            const percentage = Math.round((correctCount / totalMCQ) * 100);
            const passed = percentage >= 70;

            try {
                await database.ref(`submissions/${submissionKey}`).update({
                    correctCount: correctCount,
                    totalMCQ: totalMCQ,
                    percentage: percentage,
                    passed: passed,
                    scored: true,
                    scoredAt: new Date().toISOString(),
                    scoredBy: currentUser.email
                });

                console.log(`✅ Scored ${submission.submissionId}: ${percentage}%`);
                return true;
            } catch (error) {
                console.error('❌ Error updating score:', error);
                return false;
            }
        }

        // ============ SCORE ALL UNSCORED SUBMISSIONS ============
        async function scoreAllUnscored() {
            if (!currentUser) {
                alert('Please login first');
                return;
            }

            const scoreBtn = document.getElementById('scoreBtn');
            scoreBtn.disabled = true;
            scoreBtn.innerHTML = '<span>⏳</span><span>Scoring...</span>';

            try {
                const loaded = await loadCorrectAnswers();
                if (!loaded) {
                    scoreBtn.disabled = false;
                    scoreBtn.innerHTML = '<span>🎯</span><span>Calculate Scores</span>';
                    return;
                }

                const snapshot = await database.ref('submissions').once('value');
                const promises = [];
                let unscoredCount = 0;

                snapshot.forEach(child => {
                    const data = child.val();
                    if (!data.scored && !data.percentage) {
                        promises.push(calculateScore(child.key, data));
                        unscoredCount++;
                    }
                });

                if (unscoredCount === 0) {
                    alert('✅ All submissions already scored!');
                    scoreBtn.disabled = false;
                    scoreBtn.innerHTML = '<span>🎯</span><span>Calculate Scores</span>';
                    return;
                }

                const results = await Promise.all(promises);
                const successCount = results.filter(r => r === true).length;

                alert(`✅ Successfully scored ${successCount} of ${unscoredCount} submission(s)!`);
                loadData(); // Reload to show updated scores
            } catch (error) {
                console.error('Error:', error);
                alert('Error scoring submissions: ' + error.message);
            } finally {
                scoreBtn.disabled = false;
                scoreBtn.innerHTML = '<span>🎯</span><span>Calculate Scores</span>';
            }
        }

        // ============ LOAD DATA ============
        function loadData() {
            if (!currentUser) {
                alert('Please login first');
                return;
            }

            console.log('🔄 Loading submissions...');
            document.getElementById('tableContent').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading submissions...</p></div>';

            // Load correct answers first, then load submissions
            loadCorrectAnswers().then(() => {
                return database.ref('submissions').once('value');
            })
            .then(snapshot => {
                allSubs = [];
                
                if (!snapshot.exists()) {
                    console.log('ℹ️ No submissions found');
                    document.getElementById('tableContent').innerHTML = `
                        <div class="empty-state">
                            <h3>No Submissions Yet</h3>
                            <p>Submissions will appear here once candidates complete the assessment.</p>
                        </div>
                    `;
                    updateStats();
                    return;
                }

                snapshot.forEach(child => {
                    const data = child.val();
                    data._firebaseKey = child.key; // Store key for updates
                    allSubs.push(data);
                });
                
                console.log('✅ Loaded', allSubs.length, 'submission(s)');
                allSubs.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
                
                updateStats();
                renderTable();
            })
            .catch(err => {
                console.error('❌ Error:', err);
                const safeError = escapeHtml(err.message);
                document.getElementById('tableContent').innerHTML = `
                    <div class="empty-state">
                        <h3>Error Loading Data</h3>
                        <p>${safeError}</p>
                    </div>
                `;
            });
        }

        // ============ UPDATE STATS ============
        function updateStats() {
            const total = allSubs.length;
            const scored = allSubs.filter(s => s.scored || s.percentage !== undefined);
            const passed = scored.filter(s => s.passed).length;
            const avg = scored.length > 0 ? Math.round(scored.reduce((sum, s) => sum + safeNumber(s.percentage), 0) / scored.length) : 0;

            document.getElementById('totalSubs').textContent = total;
            document.getElementById('totalPassed').textContent = passed;
            document.getElementById('totalFailed').textContent = scored.length - passed;
            document.getElementById('avgScore').textContent = safeNumber(avg) + '%';
        }

        // ============ RENDER TABLE ============
        function renderTable() {
            if (allSubs.length === 0) {
                document.getElementById('tableContent').innerHTML = `
                    <div class="empty-state">
                        <h3>No Submissions</h3>
                        <p>No assessment submissions found.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="submissions-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Score</th>
                            <th>Status</th>
                            <th>Audio</th>
                            <th>Violations</th>
                            <th>Submitted</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            allSubs.forEach((sub, idx) => {
                const safeName = escapeHtml(sub.candidateData?.name || 'N/A');
                const safeEmail = escapeHtml(sub.candidateData?.email || 'N/A');
                const isScored = sub.scored || sub.percentage !== undefined;
                const percentage = isScored ? safeNumber(sub.percentage) : '—';
                const scoreDisplay = isScored ? `${percentage}%` : '<span style="color:var(--warning);">⏳ Pending</span>';
                const statusBadge = isScored ? 
                    `<span class="badge ${sub.passed ? 'pass' : 'fail'}">${sub.passed ? 'PASSED' : 'FAILED'}</span>` :
                    `<span class="badge unscored">UNSCORED</span>`;
                const hasAudio = sub.audioBase64 && sub.audioBase64.length > 100;
                const violations = safeNumber(sub.securityViolationCount);
                const violationColor = violations > 10 ? 'var(--danger)' : violations > 5 ? 'var(--warning)' : 'var(--success)';
                const date = safeDate(sub.submittedAt);
                
                html += `
                    <tr class="${!isScored ? 'unscored' : ''}">
                        <td><strong>${safeName}</strong></td>
                        <td>${safeEmail}</td>
                        <td><strong style="font-size:16px;">${scoreDisplay}</strong></td>
                        <td>${statusBadge}</td>
                        <td><span class="badge ${hasAudio ? 'audio-yes' : 'audio-no'}">${hasAudio ? '🎙️ YES' : '❌ NO'}</span></td>
                        <td><strong style="color:${violationColor};font-size:16px;">${violations}</strong></td>
                        <td>${date}</td>
                        <td><button class="btn-view" onclick="viewSub(${idx})">👁️ View</button></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('tableContent').innerHTML = html;
        }

        // ============ GENERATE VIOLATION BREAKDOWN ============
        function generateViolationBreakdown(sub) {
            const breakdown = sub.securityBreakdown || {};
            const total = safeNumber(sub.securityViolationCount);
            
            if (total === 0) {
                return `
                    <div class="violation-alert low">
                        ✅ No security violations detected - Clean submission
                    </div>
                `;
            }

            const violations = [
                { label: '🔄 Tab Switches', desc: 'Switched to another tab/window', count: safeNumber(breakdown.tabSwitches) },
                { label: '📋 Copy/Paste Attempts', desc: 'Tried to paste in answer fields', count: safeNumber(breakdown.pasteAttempts) },
                { label: '🖱️ Right-Click Attempts', desc: 'Right-clicked during test', count: safeNumber(breakdown.rightClicks) },
                { label: '🔧 DevTools Attempts', desc: 'Opened developer tools', count: safeNumber(breakdown.devToolsAttempts) },
                { label: '📸 Screenshot Attempts', desc: 'Pressed screenshot keys', count: safeNumber(breakdown.screenshotAttempts) },
                { label: '⌨️ Blocked Shortcuts', desc: 'Used blocked keyboard shortcuts', count: safeNumber(breakdown.keyboardShortcuts) }
            ];

            let html = `
                <div class="violation-breakdown">
                    <h4>📊 Violation Breakdown (Total: ${total})</h4>
                    <div class="violation-grid">
            `;

            violations.forEach(v => {
                if (v.count > 0) {
                    const itemClass = v.count > 5 ? 'high' : 'zero';
                    const countClass = v.count > 5 ? 'high' : '';
                    html += `
                        <div class="violation-item ${itemClass}">
                            <div class="violation-label">
                                ${escapeHtml(v.label)}
                                <small>${escapeHtml(v.desc)}</small>
                            </div>
                            <div class="violation-count ${countClass}">${v.count}</div>
                        </div>
                    `;
                }
            });

            html += '</div>';

            if (total > 10) {
                html += `<div class="violation-alert high">⚠️ HIGH VIOLATION COUNT - Manual review strongly recommended</div>`;
            } else if (total > 5) {
                html += `<div class="violation-alert moderate">⚠️ Moderate violations detected - Review recommended</div>`;
            } else {
                html += `<div class="violation-alert low">✅ Low violation count - Acceptable range</div>`;
            }

            html += '</div>';
            return html;
        }

        // ============ GENERATE ANSWERS REVIEW ============
        function generateAnswersReview(sub) {
            if (!sub.answers || sub.answers.length === 0) {
                return '<p>No answers available</p>';
            }

            const isScored = sub.scored || sub.percentage !== undefined;

            let html = `
                <div class="answers-section">
                    <h3>📝 Answer Review ${isScored ? '' : '(Unscored - Use "Calculate Scores" button)'}</h3>
            `;

            sub.answers.forEach((answer, index) => {
                const questionText = questions[index] || `Question ${index + 1}`;
                const isCorrect = isScored && index < 18 && answer === correctAnswers[index];
                const itemClass = !isScored ? '' : (isCorrect ? 'correct' : (index < 18 ? 'incorrect' : ''));

                html += `<div class="answer-item ${itemClass}">`;
                html += `<div class="answer-question">Q${index + 1}: ${escapeHtml(questionText)}</div>`;

                if (index < 18) { // MCQ
                    const options = questionOptions[index];
                    if (options && answer !== null && answer !== undefined) {
                        const answerText = options[answer] || 'Invalid answer';
                        html += `<div class="answer-response"><strong>Answer:</strong> ${escapeHtml(answerText)}</div>`;
                        
                        if (isScored) {
                            const correctText = options[correctAnswers[index]];
                            if (isCorrect) {
                                html += `<span class="answer-correct-indicator correct">✓ Correct</span>`;
                            } else {
                                html += `<span class="answer-correct-indicator incorrect">✗ Incorrect (Correct: ${escapeHtml(correctText)})</span>`;
                            }
                        }
                    } else {
                        html += `<div class="answer-response" style="color:#999;"><em>No answer provided</em></div>`;
                    }
                } else { // Written
                    if (answer && typeof answer === 'string' && answer.trim().length > 0) {
                        const words = answer.trim().split(/\s+/).length;
                        html += `<div class="answer-response"><strong>Response (${words} words):</strong><br>${escapeHtml(answer)}</div>`;
                    } else {
                        html += `<div class="answer-response" style="color:#999;"><em>No answer provided</em></div>`;
                    }
                }

                html += `</div>`;
            });

            html += `</div>`;
            return html;
        }

        // ============ VIEW SUBMISSION ============
        function viewSub(idx) {
            currentSub = allSubs[idx];
            
            const safeName = escapeHtml(currentSub.candidateData?.name || 'N/A');
            const safeEmail = escapeHtml(currentSub.candidateData?.email || 'N/A');
            const safePhone = escapeHtml(currentSub.candidateData?.phone || 'N/A');
            const safeSubmissionId = escapeHtml(currentSub.submissionId || 'N/A');
            const isScored = currentSub.scored || currentSub.percentage !== undefined;
            const percentage = isScored ? safeNumber(currentSub.percentage) : 'Not yet scored';
            const correctCount = isScored ? safeNumber(currentSub.correctCount) : '—';
            const totalMCQ = isScored ? safeNumber(currentSub.totalMCQ) : 18;
            const safeTimeTaken = escapeHtml(currentSub.timeTaken || 'N/A');
            const date = safeDate(currentSub.submittedAt);

            let html = `
                <div class="info-section">
                    <h3>👤 Candidate Information</h3>
                    <p><strong>Name:</strong> ${safeName}</p>
                    <p><strong>Email:</strong> ${safeEmail}</p>
                    <p><strong>Phone:</strong> ${safePhone}</p>
                    <p><strong>Submission ID:</strong> <code style="background:#f0f0f0;padding:4px 8px;border-radius:4px;">${safeSubmissionId}</code></p>
                </div>
            `;

            if (currentSub.audioBase64 && currentSub.audioBase64.length > 100) {
                const audioSize = Math.round(currentSub.audioBase64.length / 1024);
                html += `
                    <div class="audio-section">
                        <h3>🎤 Audio Introduction</h3>
                        <div class="audio-player">
                            <audio id="modalAudio" controls style="width:100%;">
                                <source src="${currentSub.audioBase64}" type="audio/webm">
                                <source src="${currentSub.audioBase64}" type="audio/mp4">
                            </audio>
                            <div class="audio-info">📦 Size: ${audioSize} KB</div>
                            <button class="btn btn-success" onclick="downloadAudio()">📥 Download Audio</button>
                        </div>
                    </div>
                `;
            } else {
                html += `<div style="background:#fff3cd;padding:20px;border-radius:12px;margin:20px 0;border-left:4px solid var(--warning);"><strong>⚠️ No Audio Recording</strong></div>`;
            }

            html += `
                <div class="info-section">
                    <h3>📊 Test Results</h3>
                    ${isScored ? `
                        <p><strong>Score:</strong> ${percentage}% (${correctCount}/${totalMCQ} correct)</p>
                        <p><strong>Status:</strong> <span class="badge ${currentSub.passed ? 'pass' : 'fail'}">${currentSub.passed ? 'PASSED ✓' : 'FAILED ✗'}</span></p>
                    ` : `
                        <p style="background:#fff3cd;padding:15px;border-radius:8px;"><strong>⏳ Unscored Submission</strong><br>Click "Calculate Scores" button in the dashboard to score this submission.</p>
                    `}
                    <p><strong>Time Taken:</strong> ${safeTimeTaken}</p>
                    <p><strong>Submitted:</strong> ${date}</p>
                    ${isScored && currentSub.scoredBy ? `<p><strong>Scored By:</strong> ${escapeHtml(currentSub.scoredBy)}</p>` : ''}
                </div>

                ${generateAnswersReview(currentSub)}

                <div class="info-section">
                    <h3>🔒 Security & Integrity Report</h3>
                    ${generateViolationBreakdown(currentSub)}
                </div>

                <div style="text-align:center;margin-top:30px;padding-top:30px;border-top:2px solid var(--light);">
                    <button class="btn btn-success" onclick="downloadReport()">📥 Download Report</button>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailModal').classList.add('show');

            setTimeout(() => {
                const audio = document.getElementById('modalAudio');
                if (audio) audio.load();
            }, 100);
        }

        // ============ CLOSE MODAL ============
        function closeModal() {
            const audio = document.getElementById('modalAudio');
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }
            document.getElementById('detailModal').classList.remove('show');
        }

        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // ============ DOWNLOAD AUDIO ============
        function downloadAudio() {
            if (!currentSub || !currentSub.audioBase64) {
                alert('No audio available');
                return;
            }

            try {
                const safeName = (currentSub.candidateData?.name || 'candidate').replace(/[^a-z0-9]/gi, '_');
                const link = document.createElement('a');
                link.href = currentSub.audioBase64;
                link.download = `${safeName}_Audio.webm`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (err) {
                alert('Download error: ' + escapeHtml(err.message));
            }
        }

        // ============ DOWNLOAD REPORT ============
        function downloadReport() {
            if (!currentSub) return;
            
            const safeName = escapeHtml(currentSub.candidateData?.name || 'N/A');
            const safeEmail = escapeHtml(currentSub.candidateData?.email || 'N/A');
            const safePhone = escapeHtml(currentSub.candidateData?.phone || 'N/A');
            const safeId = escapeHtml(currentSub.submissionId || 'N/A');
            const isScored = currentSub.scored || currentSub.percentage !== undefined;
            
            let report = '═══════════════════════════════════════\n';
            report += '   CUSTOMER SERVICE ASSESSMENT REPORT\n';
            report += '═══════════════════════════════════════\n\n';
            report += '📋 CANDIDATE INFORMATION\n';
            report += '─────────────────────────────────────\n';
            report += 'Name: ' + safeName + '\n';
            report += 'Email: ' + safeEmail + '\n';
            report += 'Phone: ' + safePhone + '\n';
            report += 'Submission ID: ' + safeId + '\n\n';
            report += '📊 TEST RESULTS\n';
            report += '─────────────────────────────────────\n';
            if (isScored) {
                report += 'Score: ' + safeNumber(currentSub.percentage) + '%\n';
                report += 'Correct Answers: ' + safeNumber(currentSub.correctCount) + '/' + safeNumber(currentSub.totalMCQ) + '\n';
                report += 'Status: ' + (currentSub.passed ? 'PASSED ✓' : 'FAILED ✗') + '\n';
            } else {
                report += 'Status: UNSCORED\n';
            }
            report += 'Time Taken: ' + escapeHtml(currentSub.timeTaken || 'N/A') + '\n';
            report += 'Submitted: ' + safeDate(currentSub.submittedAt) + '\n\n';
            report += '🔒 SECURITY REPORT\n';
            report += '─────────────────────────────────────\n';
            report += 'Total Violations: ' + safeNumber(currentSub.securityViolationCount) + '\n';
            report += 'Tab Switches: ' + safeNumber(currentSub.tabSwitchCount) + '\n';
            if (currentSub.securityBreakdown) {
                report += 'Paste Attempts: ' + safeNumber(currentSub.securityBreakdown.pasteAttempts) + '\n';
                report += 'DevTools Attempts: ' + safeNumber(currentSub.securityBreakdown.devToolsAttempts) + '\n';
            }
            report += '\n═══════════════════════════════════════\n';
            
            const blob = new Blob([report], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const fileName = (currentSub.candidateData?.name || 'report').replace(/[^a-z0-9]/gi, '_');
            a.href = url;
            a.download = `${fileName}_Report.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============ DOWNLOAD ALL ============
        function downloadAll() {
            if (allSubs.length === 0) {
                alert('No submissions to download');
                return;
            }

            let report = '═══════════════════════════════════════\n';
            report += '   ALL SUBMISSIONS SUMMARY\n';
            report += '═══════════════════════════════════════\n\n';
            report += 'Generated: ' + new Date().toLocaleString() + '\n';
            report += 'Total Submissions: ' + allSubs.length + '\n';
            report += 'Generated By: ' + escapeHtml(currentUser.email) + '\n\n';

            allSubs.forEach((sub, idx) => {
                const safeName = escapeHtml(sub.candidateData?.name || 'N/A');
                const safeEmail = escapeHtml(sub.candidateData?.email || 'N/A');
                const isScored = sub.scored || sub.percentage !== undefined;
                report += '─────────────────────────────────────\n';
                report += (idx + 1) + '. ' + safeName + '\n';
                report += '   Email: ' + safeEmail + '\n';
                if (isScored) {
                    report += '   Score: ' + safeNumber(sub.percentage) + '%\n';
                    report += '   Status: ' + (sub.passed ? 'PASSED' : 'FAILED') + '\n';
                } else {
                    report += '   Status: UNSCORED\n';
                }
                report += '   Violations: ' + safeNumber(sub.securityViolationCount) + '\n';
                report += '   Submitted: ' + safeDate(sub.submittedAt) + '\n\n';
            });

            report += '═══════════════════════════════════════\n';

            const blob = new Blob([report], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'All_Submissions_' + Date.now() + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        console.log('✅ Secured admin panel initialized with scoring capability');
    </script>
</body>
</html>
